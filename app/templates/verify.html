{% extends "base.html" %}

{% block content %}
    {% if context.already_verified %}
    <p>Your email has already been verified.</p>
    {% endif %}

    {% if context.verified and not context.already_verified %}
    <p>Your email has been verified.</p>
    {% endif %}

    {% if jobs %}
        <h2>Items In Your Queue</h2>
        {% for job in context.jobs%}
            <div>{{ job.args[1] }}</div>
        {% endfor %}
    {% endif %}
    <p>Drag this link into your bookmarks <a href="
javascript: (function() {
    loadjs=function(){function e(e,n){var t,r,i,c=[],o=(e=e.push?e:[e]).length,f=o;for(t=function(e,t){t.length&&c.push(e),--f||n(c)};o--;)r=e[o],(i=s[r])?t(r,i):(u[r]=u[r]||[]).push(t)}function n(e,n){if(e){var t=u[e];if(s[e]=n,t)for(;t.length;)t[0](e,n),t.splice(0,1)}}function t(e,n,r,i){var o,s,u=document,f=r.async,a=(r.numRetries||0)+1,h=r.before||c;i=i||0,/(^css!|\.css$)/.test(e)?(o=!0,(s=u.createElement('link')).rel='stylesheet',s.href=e.replace(/^css!/,'')):((s=u.createElement('script')).src=e,s.async=void 0===f||f),s.onload=s.onerror=s.onbeforeload=function(c){var u=c.type[0];if(o&&'hideFocus'in s)try{s.sheet.cssText.length||(u='e')}catch(e){u='e'}if('e'==u&&(i+=1)<a)return t(e,n,r,i);n(e,u,c.defaultPrevented)},!1!==h(e,s)&&u.head.appendChild(s)}function r(e,n,r){var i,c,o=(e=e.push?e:[e]).length,s=o,u=[];for(i=function(e,t,r){if('e'==t&&u.push(e),'b'==t){if(!r)return;u.push(e)}--o||n(u)},c=0;c<s;c++)t(e[c],i,r)}function i(e,t,i){var s,u;if(t&&t.trim&&(s=t),u=(s?i:t)||{},s){if(s in o)throw'LoadJS';o[s]=!0}r(e,function(e){e.length?(u.error||c)(e):(u.success||c)(),n(s,e)},u)}var c=function(){},o={},s={},u={};return i.ready=function(n,t){return e(n,function(e){e.length?(t.error||c)(e):(t.success||c)()}),i},i.done=function(e){n(e,[])},i.reset=function(){o={},s={},u={}},i.isDefined=function(e){return e in o},i}();

    loadjs('https://cdn.rawgit.com/mozilla/readability/8525c6af/Readability.js', {success: cleanHtml});
    const Http = new XMLHttpRequest();

    window.cleanHtml = (function() {
        var loc = document.location;
        var uri = {
            spec: loc.href,
            host: loc.host,
            prePath: loc.protocol + '//' + loc.host,
            scheme: loc.protocol.substr(0, loc.protocol.indexOf(':')),
            pathBase: loc.protocol + '//' + loc.host + loc.pathname.substr(0, loc.pathname.lastIndexOf('/') + 1)
        };
        var article = new Readability(uri, document.cloneNode(true)).parse();
        console.log(article);
        Http.open('POST', '{{ request.url_root }}api', true);
        Http.setRequestHeader('Content-Type', 'application/json');
        Http.onreadystatechange = function() {
            if (Http.readyState === 4 && Http.status === 200) {
                var json = JSON.parse(Http.responseText);
                if (json.success) {
                    alert('Sent to kindle :)');
                } else {
                    alert('Failed to send to kindle :(');
                }
            }
        };
        try {
            Http.send(JSON.stringify({
                token: '{{ context.api_token }}',
                html: article.content,
                title: article.title
            }));
        } catch (err) {
            alert('Oops, something went wrong sending to kindle, sorry about that <3.');
        }
    });
})()

      ">Send To Kindle</a></p>
        <p>When you want to send a webpage to your Kindle just click the bookmark.</p>
{% endblock %}
